use std::collections::VecDeque;

// Low-pass filter implemented using a FIR
#[derive(Debug, Clone)]
pub struct LowPassFilter {
    samples: VecDeque<f64>,
}

impl LowPassFilter {
    pub fn new() -> Self {
        Self {
            samples: VecDeque::new(),
        }
    }

    pub fn collect_sample(&mut self, sample: f64) {
        self.samples.push_back(sample);
        if self.samples.len() > FIR_COEFFICIENTS.len() {
            self.samples.pop_front();
        }
    }

    pub fn output_sample(&self) -> f64 {
        FIR_COEFFICIENT_0
            + self
                .samples
                .iter()
                .copied()
                .zip(FIR_COEFFICIENTS.iter().copied())
                .map(|(a, b)| a * b)
                .sum::<f64>()
    }
}

impl Default for LowPassFilter {
    fn default() -> Self {
        Self::new()
    }
}

// Generated in Octave using `fir1(381, 24000 / (1048576 / 2), 'low')`
const FIR_COEFFICIENT_0: f64 = 0.0001178990887453464;

#[allow(clippy::excessive_precision)]
const FIR_COEFFICIENTS: [f64; 381] = [
    0.0001178990887453465,
    0.0001192492171088911,
    0.0001184292264743118,
    0.0001154074396009657,
    0.0001101771318172926,
    0.0001027579463436797,
    9.319746423414551e-05,
    8.157286475908553e-05,
    6.799259032612744e-05,
    5.259791087000981e-05,
    3.556426695087971e-05,
    1.710225940736412e-05,
    -2.541852981558975e-06,
    -2.308628720989639e-05,
    -4.42146354190509e-05,
    -6.557765299305744e-05,
    -8.679604109163093e-05,
    -0.0001074643061001998,
    -0.0001271557497760715,
    -0.0001454286103461993,
    -0.0001618333372970516,
    -0.0001759209420988295,
    -0.000187252324784206,
    -0.0001954084334373606,
    -0.0002000010716116467,
    -0.0002006841289027502,
    -0.000197164973786556,
    -0.0001892157167810129,
    -0.0001766840273257714,
    -0.0001595031706888622,
    -0.0001377009227417893,
    -0.0001114070214298438,
    -8.085882480716468e-05,
    -4.640486694903416e-05,
    -8.506034956662485e-06,
    3.226586760647521e-05,
    7.523235370732795e-05,
    0.0001196154044979785,
    0.0001645475935552526,
    0.0002090851630576211,
    0.0002522239520942417,
    0.0002929179954465203,
    0.0003301005286966554,
    0.0003627070545929693,
    0.0003897000485049419,
    0.0004100948098144866,
    0.0004229859034526444,
    0.0004275735836350997,
    0.0004231895521409612,
    0.0004093213779554068,
    0.0003856348952134474,
    0.0003519939032608305,
    0.0003084765170324523,
    0.000255387558167721,
    0.0001932664372238916,
    0.000122890054441971,
    4.52703397311154e-05,
    -3.835383962594314e-05,
    -0.0001265305545145715,
    -0.0002176144928665122,
    -0.0003097923234491758,
    -0.0004011134830193822,
    -0.0004895259808541042,
    -0.0005729166723808618,
    -0.0006491553170689443,
    -0.000716141608510044,
    -0.0007718542502487842,
    -0.0008144010528018168,
    -0.0008420689485673984,
    -0.0008533727647851414,
    -0.0008471015627566504,
    -0.0008223613460951042,
    -0.0007786129631974217,
    -0.0007157040801823186,
    -0.0006338941803189546,
    -0.0005338716539149351,
    -0.000416762177480654,
    -0.0002841277407938895,
    -0.0001379558626413871,
    1.93612627316489e-05,
    0.0001850577299018717,
    0.0003560348112433294,
    0.000528911350916924,
    0.0007000830094731402,
    0.000865789474206511,
    0.001022188529643313,
    0.001165435676928977,
    0.001291767805713956,
    0.001397589262461837,
    0.001479558529582268,
    0.001534673634579789,
    0.001560354351045957,
    0.001554519236624471,
    0.001515655579056069,
    0.001442880391187554,
    0.00133599070959431,
    0.001195501608429195,
    0.001022670538492918,
    0.0008195068385569329,
    0.0005887655379382582,
    0.0003339248715995506,
    5.914725616781496e-05,
    -0.0002307761789676324,
    -0.0005304970537276771,
    -0.0008341963787454109,
    -0.001135685203336846,
    -0.001428517749396731,
    -0.001706115181623776,
    -0.001961897862208459,
    -0.00218942366995949,
    -0.002382529736746988,
    -0.002535474774392646,
    -0.002643079038221349,
    -0.002700858903934341,
    -0.002705153025722766,
    -0.002653237097880002,
    -0.002543424360592549,
    -0.002375149172768102,
    -0.002149031219015964,
    -0.001866918221190238,
    -0.001531905382869468,
    -0.001148330202129829,
    -0.000721741737132834,
    -0.0002588438924718782,
    0.0002325871969583689,
    0.0007438110832357612,
    0.001265255092419336,
    0.001786668924954348,
    0.00229729960418763,
    0.002786084125550804,
    0.003241856714156456,
    0.003653567201156237,
    0.004010506688602347,
    0.004302536397196301,
    0.004520315388556184,
    0.004655522729557457,
    0.004701069625536296,
    0.004651297094757065,
    0.004502154889941743,
    0.004251357593515886,
    0.003898514119459495,
    0.003445227242423448,
    0.00289516023852986,
    0.002254068254826292,
    0.001529792616991794,
    0.0007322169274977194,
    -0.0001268155122965187,
    -0.001033622714990575,
    -0.001972842492885995,
    -0.002927626733979464,
    -0.003879869079165185,
    -0.00481046293328055,
    -0.005699586105963263,
    -0.006527007796311064,
    -0.007272413120252752,
    -0.007915739942477481,
    -0.008437522425536897,
    -0.008819235455608736,
    -0.009043633953950773,
    -0.009095081039965574,
    -0.008959859078734285,
    -0.008626457823480774,
    -0.008085834150201428,
    -0.007331638274032784,
    -0.006360401829148365,
    -0.005171683778412097,
    -0.003768170786139768,
    -0.002155729425905675,
    -0.000343408392651561,
    0.001656610269587255,
    0.003829111041237255,
    0.006155995133148218,
    0.008616479372499415,
    0.01118734125109357,
    0.01384320678799159,
    0.01655687707817268,
    0.01929968868366893,
    0.02204190238713619,
    0.02475311428243195,
    0.02740268273320913,
    0.02996016439770191,
    0.03239575230266457,
    0.03468070885655419,
    0.03678778672399142,
    0.03869163064043982,
    0.0403691535257278,
    0.04179988065301301,
    0.04296625613934637,
    0.04385390663631524,
    0.04445185780357706,
    0.04475269993193354,
    0.04475269993193354,
    0.04445185780357706,
    0.04385390663631524,
    0.04296625613934637,
    0.04179988065301301,
    0.04036915352572779,
    0.03869163064043982,
    0.03678778672399142,
    0.03468070885655419,
    0.03239575230266457,
    0.02996016439770191,
    0.02740268273320913,
    0.02475311428243195,
    0.02204190238713619,
    0.01929968868366893,
    0.01655687707817267,
    0.01384320678799159,
    0.01118734125109357,
    0.008616479372499417,
    0.006155995133148217,
    0.003829111041237256,
    0.001656610269587254,
    -0.0003434083926515605,
    -0.002155729425905677,
    -0.003768170786139767,
    -0.005171683778412095,
    -0.006360401829148364,
    -0.007331638274032785,
    -0.008085834150201428,
    -0.008626457823480772,
    -0.008959859078734285,
    -0.009095081039965572,
    -0.009043633953950775,
    -0.008819235455608742,
    -0.008437522425536899,
    -0.007915739942477483,
    -0.007272413120252752,
    -0.006527007796311065,
    -0.005699586105963262,
    -0.00481046293328055,
    -0.003879869079165186,
    -0.002927626733979464,
    -0.001972842492885996,
    -0.001033622714990575,
    -0.0001268155122965183,
    0.0007322169274977195,
    0.001529792616991795,
    0.002254068254826292,
    0.002895160238529863,
    0.00344522724242345,
    0.003898514119459494,
    0.004251357593515886,
    0.004502154889941744,
    0.004651297094757065,
    0.004701069625536294,
    0.00465552272955746,
    0.004520315388556188,
    0.004302536397196298,
    0.004010506688602342,
    0.003653567201156236,
    0.003241856714156453,
    0.002786084125550802,
    0.002297299604187627,
    0.001786668924954349,
    0.001265255092419335,
    0.0007438110832357614,
    0.0002325871969583697,
    -0.0002588438924718778,
    -0.0007217417371328342,
    -0.00114833020212983,
    -0.001531905382869469,
    -0.001866918221190239,
    -0.002149031219015963,
    -0.002375149172768102,
    -0.002543424360592548,
    -0.002653237097880001,
    -0.002705153025722766,
    -0.002700858903934344,
    -0.002643079038221349,
    -0.002535474774392646,
    -0.002382529736746988,
    -0.00218942366995949,
    -0.001961897862208459,
    -0.001706115181623776,
    -0.001428517749396731,
    -0.001135685203336846,
    -0.0008341963787454101,
    -0.0005304970537276776,
    -0.0002307761789676326,
    5.914725616781571e-05,
    0.0003339248715995512,
    0.0005887655379382579,
    0.0008195068385569326,
    0.001022670538492917,
    0.001195501608429195,
    0.00133599070959431,
    0.001442880391187555,
    0.00151565557905607,
    0.001554519236624472,
    0.001560354351045957,
    0.00153467363457979,
    0.001479558529582269,
    0.001397589262461838,
    0.001291767805713957,
    0.001165435676928977,
    0.001022188529643312,
    0.0008657894742065109,
    0.0007000830094731402,
    0.0005289113509169241,
    0.0003560348112433291,
    0.0001850577299018716,
    1.936126273164864e-05,
    -0.0001379558626413873,
    -0.0002841277407938897,
    -0.0004167621774806545,
    -0.0005338716539149348,
    -0.0006338941803189548,
    -0.0007157040801823193,
    -0.0007786129631974226,
    -0.0008223613460951052,
    -0.0008471015627566496,
    -0.0008533727647851418,
    -0.0008420689485673996,
    -0.0008144010528018179,
    -0.0007718542502487841,
    -0.0007161416085100453,
    -0.000649155317068944,
    -0.0005729166723808623,
    -0.0004895259808541044,
    -0.0004011134830193819,
    -0.0003097923234491752,
    -0.0002176144928665118,
    -0.0001265305545145715,
    -3.835383962594245e-05,
    4.527033973111567e-05,
    0.0001228900544419709,
    0.0001932664372238915,
    0.0002553875581677213,
    0.0003084765170324526,
    0.0003519939032608312,
    0.0003856348952134474,
    0.000409321377955407,
    0.0004231895521409616,
    0.0004275735836350995,
    0.0004229859034526453,
    0.000410094809814487,
    0.0003897000485049421,
    0.0003627070545929693,
    0.0003301005286966561,
    0.0002929179954465205,
    0.0002522239520942421,
    0.0002090851630576211,
    0.0001645475935552524,
    0.0001196154044979785,
    7.523235370732786e-05,
    3.226586760647529e-05,
    -8.506034956662552e-06,
    -4.640486694903419e-05,
    -8.085882480716467e-05,
    -0.0001114070214298438,
    -0.0001377009227417895,
    -0.0001595031706888625,
    -0.0001766840273257716,
    -0.0001892157167810127,
    -0.0001971649737865563,
    -0.0002006841289027503,
    -0.0002000010716116467,
    -0.0001954084334373605,
    -0.0001872523247842062,
    -0.0001759209420988296,
    -0.0001618333372970516,
    -0.0001454286103461991,
    -0.0001271557497760715,
    -0.0001074643061001999,
    -8.679604109163093e-05,
    -6.557765299305748e-05,
    -4.421463541905093e-05,
    -2.308628720989644e-05,
    -2.541852981558984e-06,
    1.710225940736415e-05,
    3.556426695087972e-05,
    5.259791087000982e-05,
    6.799259032612745e-05,
    8.157286475908557e-05,
    9.319746423414557e-05,
    0.0001027579463436798,
    0.0001101771318172925,
    0.0001154074396009659,
    0.0001184292264743119,
    0.0001192492171088911,
];
